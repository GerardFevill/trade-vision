<div class="portfolio-detail-page">
  <!-- Back Button -->
  <a routerLink="/portfolios" class="back-link">
    <i class="fa fa-arrow-left"></i> Retour
  </a>

  <!-- Loading -->
  @if (loading() && !portfolio()) {
    <div class="loading-state">
      <i class="fa fa-spinner fa-spin"></i>
      <p>Chargement...</p>
    </div>
  }

  <!-- Error -->
  @if (error()) {
    <div class="error-banner">
      <i class="fa fa-exclamation-triangle"></i> {{ error() }}
    </div>
  }

  @if (portfolio(); as p) {
    <!-- Compact Header -->
    <header class="page-header" [class]="getTypeClass()">
      <div class="header-main">
        <div class="type-icon" [class]="getTypeClass()">
          <i class="fa" [class]="getTypeIcon()"></i>
        </div>
        <div class="header-info">
          <h1>{{ p.name }}</h1>
          <div class="header-badges">
            <span class="badge client">{{ p.client }}</span>
            <span class="badge type" [class]="getTypeClass()">{{ p.type }}</span>
          </div>
        </div>
      </div>
      <div class="header-stats">
        @if (p.type === 'Securise' && totalsByCurrency().length > 1) {
          <!-- Multiple currencies for Securise -->
          @for (t of totalsByCurrency(); track t.currency) {
            <div class="stat currency-stat">
              <span class="currency-label">{{ t.currency }}</span>
              <span class="value">{{ fmt.formatCurrency(t.balance, t.currency) }}</span>
              <span class="value profit" [class]="fmt.getProfitClass(t.profit)">
                {{ fmt.formatCurrency(t.profit, t.currency) }}
              </span>
            </div>
          }
        } @else {
          <!-- Single currency or other types -->
          <div class="stat">
            <span class="value">{{ fmt.formatCurrency(p.total_balance, totalsByCurrency()[0]?.currency || 'EUR') }}</span>
            <span class="label">Balance</span>
          </div>
          <div class="stat">
            <span class="value" [class]="fmt.getProfitClass(p.total_profit)">
              {{ fmt.formatCurrency(p.total_profit, totalsByCurrency()[0]?.currency || 'EUR') }}
            </span>
            <span class="label">Profit global</span>
          </div>
        }
        <div class="stat">
          @if (p.type === 'Securise') {
            <span class="value">{{ p.account_count }}</span>
          } @else {
            <span class="value">{{ p.account_count }}/{{ p.available_factors.length }}</span>
          }
          <span class="label">Comptes</span>
        </div>
      </div>
    </header>

    <!-- Monthly Performance -->
    @if (monthlyPreview(); as preview) {
      <section class="monthly-section">
        <!-- Month Header with Progress -->
        <div class="month-header-bar">
          <div class="month-title">
            <h2>{{ formatMonth(preview.month) }}</h2>
            @if (preview.is_elite) {
              <span class="phase-pill phase-{{ preview.phase }}">
                Phase {{ preview.phase }} · {{ preview.phase_name }}
              </span>
            }
          </div>
          <div class="month-progress">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="(preview.days_elapsed / preview.days_in_month) * 100"></div>
            </div>
            <span class="progress-text">{{ preview.days_elapsed }}/{{ preview.days_in_month }}j</span>
          </div>
        </div>

        <!-- Key Metrics Row -->
        <div class="metrics-row">
          <div class="metric">
            <span class="metric-value">{{ fmt.formatCurrency(preview.total_starting, 'EUR') }}</span>
            <span class="metric-label">Debut mois</span>
          </div>
          <div class="metric-arrow"><i class="fa fa-arrow-right"></i></div>
          <div class="metric">
            <span class="metric-value">{{ fmt.formatCurrency(preview.total_current, 'EUR') }}</span>
            <span class="metric-label">Actuel</span>
          </div>
          <div class="metric-equals">=</div>
          <div class="metric highlight">
            <span class="metric-value" [class]="fmt.getProfitClass(preview.total_profit)">
              {{ fmt.formatCurrency(preview.total_profit, 'EUR') }}
            </span>
            <span class="metric-label">Profit ({{ preview.total_profit_percent.toFixed(1) }}%)</span>
          </div>
        </div>

        @if (preview.is_elite) {
          <!-- Elite Distribution Bar -->
          <div class="distribution-section">
            <h3>Repartition du profit</h3>
            <div class="distribution-visual">
              <div class="dist-bar">
                @if (preview.total_profit > 0) {
                  <div class="segment remun"
                       [style.width.%]="((preview.total_remuneration || 0) / preview.total_profit) * 100">
                    <span class="segment-value">{{ fmt.formatCurrency(preview.total_remuneration || 0, 'EUR') }}</span>
                  </div>
                  <div class="segment compound"
                       [style.width.%]="((preview.total_compound || 0) / preview.total_profit) * 100">
                    <span class="segment-value">{{ fmt.formatCurrency(preview.total_compound || 0, 'EUR') }}</span>
                  </div>
                  <div class="segment transfer"
                       [style.width.%]="((preview.total_transfer || 0) / preview.total_profit) * 100">
                    <span class="segment-value">{{ fmt.formatCurrency(preview.total_transfer || 0, 'EUR') }}</span>
                  </div>
                }
              </div>
              <div class="dist-legend">
                <div class="legend-item remun">
                  <span class="dot"></span>
                  <span class="text">A retirer</span>
                </div>
                <div class="legend-item compound">
                  <span class="dot"></span>
                  <span class="text">Compound</span>
                </div>
                <div class="legend-item transfer">
                  <span class="dot"></span>
                  <span class="text">Transferts</span>
                </div>
              </div>
            </div>

            <!-- Withdrawal Highlight -->
            <div class="withdrawal-highlight">
              <i class="fa fa-hand-holding-usd"></i>
              <div class="withdrawal-info">
                <span class="withdrawal-label">A retirer ce mois</span>
                <span class="withdrawal-value">{{ fmt.formatCurrency(preview.total_remuneration || 0, 'EUR') }}</span>
              </div>
            </div>
          </div>

          <!-- Elite Accounts Table -->
          <div class="accounts-table-section">
            <table class="elite-accounts-table">
              <thead>
                <tr>
                  <th class="col-level">Niveau</th>
                  <th class="col-account">Compte</th>
                  <th class="col-number">Debut</th>
                  <th class="col-number">Actuel</th>
                  <th class="col-number">Profit</th>
                  <th class="col-number">Retrait</th>
                </tr>
              </thead>
              <tbody>
                @for (acc of preview.elite_accounts; track acc.account_id) {
                  <tr>
                    <td class="col-level">
                      <span class="level-chip level-{{ acc.level }}">{{ acc.level }}</span>
                      <br>
                      <span class="factor-text">{{ acc.lot_factor }}x</span>
                    </td>
                    <td class="col-account">
                      <span class="account-name">{{ acc.account_name }}</span>
                      <span class="account-id">#{{ acc.account_id }}</span>
                    </td>
                    <td class="col-number">{{ fmt.formatCurrency(acc.starting_balance, acc.currency) }}</td>
                    <td class="col-number">{{ fmt.formatCurrency(acc.current_balance, acc.currency) }}</td>
                    <td class="col-number" [class]="fmt.getProfitClass(acc.monthly_profit)">
                      {{ fmt.formatCurrency(acc.monthly_profit, acc.currency) }}
                      <small>({{ acc.profit_percent.toFixed(0) }}%)</small>
                    </td>
                    <td class="col-number remun-value">
                      {{ fmt.formatCurrency(acc.remuneration, acc.currency) }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Transfers Flow -->
          @if (preview.transfers && preview.transfers.length > 0) {
            <div class="transfers-section">
              <h3><i class="fa fa-exchange-alt"></i> Flux de transferts</h3>
              <div class="transfers-flow">
                @for (t of preview.transfers; track t.from_level) {
                  <div class="transfer-flow-item">
                    <div class="flow-endpoint">
                      <span class="flow-from level-{{ t.from_level }}">{{ t.from_level }}</span>
                      <span class="flow-account-id">#{{ t.from_account_id }}</span>
                    </div>
                    <div class="flow-arrow">
                      <span class="flow-amount">{{ fmt.formatCurrency(t.amount, 'EUR') }}</span>
                      <i class="fa fa-long-arrow-alt-right"></i>
                    </div>
                    <div class="flow-endpoint">
                      <span class="flow-to level-{{ t.to_level }}">{{ t.to_level }}</span>
                      <span class="flow-account-id">#{{ t.to_account_id }}</span>
                    </div>
                  </div>
                }
              </div>
            </div>
          }

        } @else {
          <!-- Standard System (Modere, Agressif) -->
          <div class="withdrawal-highlight">
            <i class="fa fa-hand-holding-usd"></i>
            <div class="withdrawal-info">
              <span class="withdrawal-label">Retrait suggere ({{ preview.withdrawal_percentage }}%)</span>
              <span class="withdrawal-value">{{ fmt.formatCurrency(preview.total_suggested_withdrawal || 0, 'EUR') }}</span>
            </div>
          </div>

          <div class="accounts-table-section">
            <table class="standard-accounts-table">
              <thead>
                <tr>
                  <th>Compte</th>
                  <th>Facteur</th>
                  <th class="col-number">
                    Debut
                    <button class="btn-edit-inline" (click)="toggleEditMode()"><i class="fa fa-edit"></i></button>
                  </th>
                  <th class="col-number">Actuel</th>
                  <th class="col-number">Profit</th>
                  <th class="col-number">Retrait</th>
                </tr>
              </thead>
              <tbody>
                @for (acc of preview.accounts; track acc.account_id) {
                  <tr>
                    <td class="col-account">
                      <span class="account-name">{{ acc.account_name }}</span>
                      <span class="account-id">#{{ acc.account_id }}</span>
                    </td>
                    <td class="col-factor">{{ acc.lot_factor }}x</td>
                    <td class="col-number">
                      @if (editingStartingBalance() === acc.account_id) {
                        <input type="number" class="inline-input" [value]="acc.starting_balance"
                          (keyup.enter)="saveStartingBalance(acc.account_id, $any($event.target).value)"
                          (keyup.escape)="cancelEdit()" #balanceInput />
                      } @else {
                        <span class="editable-value" (click)="startEditBalance(acc.account_id)">
                          {{ fmt.formatCurrency(acc.starting_balance, acc.currency) }}
                        </span>
                      }
                    </td>
                    <td class="col-number">{{ fmt.formatCurrency(acc.current_balance, acc.currency) }}</td>
                    <td class="col-number" [class]="fmt.getProfitClass(acc.monthly_profit)">
                      {{ fmt.formatCurrency(acc.monthly_profit, acc.currency) }}
                      <small>({{ acc.profit_percent.toFixed(0) }}%)</small>
                    </td>
                    <td class="col-number remun-value">
                      {{ fmt.formatCurrency(acc.suggested_withdrawal, acc.currency) }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </section>
    }

    <!-- Monthly History -->
    @if (monthlyHistory().length > 0) {
      <section class="history-section">
        <h2><i class="fa fa-history"></i> Historique</h2>
        <div class="history-timeline">
          @for (month of monthlyHistory(); track month) {
            <div class="history-card" [class.expanded]="selectedHistoryMonth() === month">
              <div class="history-card-header" (click)="viewHistoryMonth(month)">
                <span class="month-name">{{ formatMonth(month) }}</span>
                @if (selectedHistoryMonth() === month && historyData(); as h) {
                  <span class="month-summary">
                    <span [class]="fmt.getProfitClass(h.total_profit)">
                      {{ fmt.formatCurrency(h.total_profit, 'EUR') }}
                    </span>
                    @if (h.total_remuneration !== undefined) {
                      <span class="sep">·</span>
                      <span class="remun-mini">{{ fmt.formatCurrency(h.total_remuneration, 'EUR') }} retire</span>
                    }
                  </span>
                }
                <i class="fa" [class.fa-chevron-down]="selectedHistoryMonth() !== month"
                   [class.fa-chevron-up]="selectedHistoryMonth() === month"></i>
              </div>

              @if (selectedHistoryMonth() === month && historyData(); as history) {
                <div class="history-card-body">
                  <div class="history-metrics">
                    <div class="h-metric">
                      <span class="label">Debut</span>
                      <span class="value">{{ fmt.formatCurrency(history.total_starting, 'EUR') }}</span>
                    </div>
                    <div class="h-metric">
                      <span class="label">Fin</span>
                      <span class="value">{{ fmt.formatCurrency(history.total_ending, 'EUR') }}</span>
                    </div>
                    <div class="h-metric profit">
                      <span class="label">Profit</span>
                      <span class="value" [class]="fmt.getProfitClass(history.total_profit)">
                        {{ fmt.formatCurrency(history.total_profit, 'EUR') }}
                      </span>
                    </div>
                    @if (history.total_remuneration !== undefined) {
                      <div class="h-metric remun">
                        <span class="label">Retire</span>
                        <span class="value">{{ fmt.formatCurrency(history.total_remuneration, 'EUR') }}</span>
                      </div>
                    }
                  </div>

                  <table class="history-table-compact">
                    <tbody>
                      @for (acc of history.accounts; track acc.account_id) {
                        <tr>
                          @if (acc.level) {
                            <td class="col-level"><span class="level-chip level-{{ acc.level }}">{{ acc.level }}</span></td>
                          }
                          <td>
                            <span class="account-name">{{ acc.account_name }}</span>
                            <span class="account-id">#{{ acc.account_id }}</span>
                          </td>
                          <td class="col-number" [class]="fmt.getProfitClass(acc.monthly_profit || acc.profit)">
                            {{ fmt.formatCurrency(acc.monthly_profit || acc.profit, acc.currency) }}
                          </td>
                          @if (acc.remuneration !== undefined) {
                            <td class="col-number remun-value">{{ fmt.formatCurrency(acc.remuneration, acc.currency) }}</td>
                          }
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }
            </div>
          }
        </div>
      </section>
    }

    <!-- Accounts Section -->
    <section class="factors-section">
      <h2><i class="fa fa-layer-group"></i> Comptes</h2>

      @if (p.type === 'Securise') {
        <!-- Securise: Accounts grouped by currency -->
        <div class="securise-accounts">
          @for (currencyGroup of accountsByCurrency() | keyvalue; track currencyGroup.key) {
            <div class="currency-group">
              <div class="currency-header">
                <span class="currency-badge">{{ currencyGroup.key }}</span>
                <span class="currency-total">
                  {{ fmt.formatCurrency(getCurrencyTotal(currencyGroup.key), currencyGroup.key) }}
                </span>
              </div>
              <div class="accounts-list">
                @for (acc of currencyGroup.value; track acc.account_id) {
                  @if (acc.account) {
                    <div class="factor-account">
                      <div class="account-info">
                        <span class="name">{{ acc.account.name }}</span>
                        <span class="account-id">#{{ acc.account_id }}</span>
                        <span class="balance">{{ fmt.formatCurrency(acc.account.balance, acc.account.currency) }}</span>
                      </div>
                      <button class="btn-remove-mini" (click)="removeAccount(acc.account_id, $event)">
                        <i class="fa fa-times"></i>
                      </button>
                    </div>
                  } @else {
                    <div class="factor-account missing">
                      <span>#{{ acc.account_id }} introuvable</span>
                      <button class="btn-remove-mini" (click)="removeAccount(acc.account_id, $event)">
                        <i class="fa fa-times"></i>
                      </button>
                    </div>
                  }
                }
              </div>
            </div>
          } @empty {
            <div class="empty-factor" (click)="openAccountSelector(1)">
              <i class="fa fa-plus"></i> Ajouter un compte
            </div>
          }
          <div class="add-more" (click)="openAccountSelector(1)">
            <i class="fa fa-plus"></i> Ajouter un compte
          </div>
        </div>
      } @else {
        <!-- Other types: Accounts by Factor -->
        <div class="factors-grid">
          @for (factor of p.available_factors; track factor) {
            <div class="factor-card">
              <div class="factor-header">
                <span class="factor-value">{{ factor }}x</span>
                <span class="factor-count">{{ (accountsByFactor().get(factor) || []).length }}</span>
              </div>
              <div class="factor-body">
                @for (acc of accountsByFactor().get(factor) || []; track acc.account_id) {
                  @if (acc.account) {
                    <div class="factor-account">
                      <div class="account-info">
                        <span class="name">{{ acc.account.name }}</span>
                        <span class="account-id">#{{ acc.account_id }}</span>
                        <span class="balance">{{ fmt.formatCurrency(acc.account.balance, acc.account.currency) }}</span>
                      </div>
                      <button class="btn-remove-mini" (click)="removeAccount(acc.account_id, $event)">
                        <i class="fa fa-times"></i>
                      </button>
                    </div>
                  } @else {
                    <div class="factor-account missing">
                      <span>#{{ acc.account_id }} introuvable</span>
                      <button class="btn-remove-mini" (click)="removeAccount(acc.account_id, $event)">
                        <i class="fa fa-times"></i>
                      </button>
                    </div>
                  }
                } @empty {
                  <div class="empty-factor" (click)="openAccountSelector(factor)">
                    <i class="fa fa-plus"></i> Ajouter
                  </div>
                }
                @if ((accountsByFactor().get(factor) || []).length > 0 && p.type === 'Modere') {
                  <div class="add-more" (click)="openAccountSelector(factor)">
                    <i class="fa fa-plus"></i>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
    </section>
  }

  <!-- Account Selector Modal -->
  @if (showAccountSelector()) {
    <div class="modal-backdrop" (click)="closeAccountSelector()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <app-account-selector
          [accounts]="availableAccounts()"
          [usedAccountIds]="getUsedAccountIds()"
          [selectedFactor]="selectedFactor()!"
          [portfolioClient]="portfolio()?.client || ''"
          (selected)="onAccountSelected($event)"
          (cancelled)="closeAccountSelector()">
        </app-account-selector>
      </div>
    </div>
  }
</div>
